<?xml version="1.0" encoding="UTF-8"?>
<odoo>

	<template id="report_saleorder_document_dusal"
		inherit_id="dusal_sale.report_saleorder_document_dusal">
		<xpath expr="//td[@t-if='doc.print_product_image']" position="replace">
			<td t-if="doc.print_product_image">
				<span t-if="doc.image_size == 'small'"><img t-if="l['product_image_small']" t-att-src="'data:image/png;base64,%s' % to_text(l['product_image_small'])" width="32" height="32" /></span>
				<span t-if="doc.image_size == 'medium'"><img t-if="l['product_image_medium']" t-att-src="'data:image/png;base64,%s' % to_text(l['product_image_medium'])" width="64" height="64" /></span>
				<span t-if="doc.image_size == 'big'"><img t-if="l['product_image']" t-att-src="'data:image/png;base64,%s' % to_text(l['product_image'])" width="128" height="128" /></span>
			</td>
		</xpath>
	</template>

	<template id="report_saleorder_document" inherit_id="sale.report_saleorder_document"
		priority="10">
		<xpath expr="//div[hasclass('page')]" position="attributes">
			<attribute name="style">font-size:10px;</attribute>
		</xpath>
		<xpath expr="//div[@t-field='doc.partner_id']" position="attributes">
			<attribute name="t-options">{"widget": "contact", "fields": ["address", "name", "phone"], "no_marker": True, "phone_icons": True}</attribute>
		</xpath>
		<xpath expr="//p[@t-field='doc.validity_date']/.." position="before">
			<div t-if="doc.carrier_id" class="col-auto mw-100 mb-2">
                <strong>Metodo de envio:</strong>
                <p class="m-0" t-field="doc.carrier_id"/>
            </div>
		</xpath>
		<xpath expr="//t[@t-set='display_discount']" position="replace">
			<t t-set="display_discount" t-value="any([l.discount or l.discount_value for l in doc.order_line])"/>
		</xpath>
		<xpath expr="//tbody[hasclass('sale_tbody')]/.." position="replace">
			<table class="table table-sm" style="padding:10px;">
				<thead>
					<tr>
						<t t-set="colspan" t-value="5"/>
						<th class="text-left" style="min-width:75px;max-width:75px;">CÃ³digo</th>
						<th class="text-left" style="min-width:125px;max-width:125px;">Detalle</th>
						<t t-if="show_atributes_on_reports== 'show_attributes'">
							<th class="text-center" groups="product.group_product_variant">Color</th>
							<th class="text-center" groups="product.group_product_variant">Tallas</th>
						</t>
						<th class="text-right">Cantidad</th>
						<th class="text-right" style="min-width:60px;max-width:60px;">P. Unit.
						</th>
						<th t-if="display_discount" class="text-left"
							groups="sale.group_discount_per_so_line">
							<span>Desc. <t t-if="show_discount_on_report == 'percentaje'">(%)</t></span>
						</th>
						<th class="text-right">Impuestos</th>
						<th class="text-right" style="min-width:70px;max-width:70px;">
							<t groups="account.group_show_line_subtotals_tax_excluded">Subtotal</t>
							<t groups="account.group_show_line_subtotals_tax_included">Total</t>
						</th>
					</tr>
				</thead>
				<tbody class="sale_tbody">
					<t t-set="current_subtotal" t-value="0" />
					<t t-set="quantity_total" t-value="0" />
					<t t-set="order_lines" t-value="doc._get_lines_by_template()" />
					<t t-foreach="order_lines" t-as="l">
						<t t-set="current_subtotal" t-value="current_subtotal + l['price_subtotal']"
							groups="account.group_show_line_subtotals_tax_excluded" />
						<t t-set="current_subtotal" t-value="current_subtotal + l['price_total']"
							groups="account.group_show_line_subtotals_tax_included" />
						<t t-set="quantity_total" t-value="quantity_total+l['quantity']" />
						<tr
							t-att-class="'bg-200 font-weight-bold' if l['display_type'] == 'line_section' else 'font-italic' if l['display_type'] == 'line_note' else ''">
							<t t-if="not l['display_type']">
								<td>
									<span t-esc="l['default_code']" />
								</td>
								<td
									style="min-width:125px;max-width:125px;white-space: nowrap;overflow: hidden;text-overflow: ellipsis;">
									<span t-esc="l['name']" />
								</td>
								<t t-if="show_atributes_on_reports== 'show_attributes'">
									<td groups="product.group_product_variant">
										<span t-esc="l['color']" />
									</td>
									<td groups="product.group_product_variant">
										<span t-raw="', '.join(l['attributes'])" />
									</td>
								</t>
								<td class="text-right">
									<span t-esc="l['quantity']"
										t-options="{'widget': 'float', 'decimal_precision': 'Product Unit of Measure'}" />
									<span t-esc="l['product_uom']" groups="uom.group_uom" />
								</td>
								<td class="text-right">
									<span t-esc="l['price_unit']"
										t-options="{'widget': 'monetary', 'display_currency': doc.pricelist_id.currency_id}" />
								</td>
								<td t-if="display_discount" class="text-right"
									groups="sale.group_discount_per_so_line">
									<t t-if="show_discount_on_report == 'percentaje'">
										<span t-esc="l['discount']"  t-options="{'widget': 'float', 'decimal_precision': 'Discount'}"/>
									</t>
									<t t-if="show_discount_on_report != 'percentaje'">
										<span t-esc="l['discount']"  t-options="{'widget': 'monetary', 'display_currency': doc.pricelist_id.currency_id}"/>
									</t>
								</td>
								<td class="text-right">
									<span
										t-esc="', '.join(map(lambda x: (x.description or x.name), l['tax_id']))" />
								</td>
								<td class="text-right">
									<span t-esc="l['price_subtotal']"
										t-options="{'widget': 'monetary', 'display_currency': doc.pricelist_id.currency_id}"
										groups="account.group_show_line_subtotals_tax_excluded" />
									<span t-esc="l['price_total']"
										t-options="{'widget': 'monetary', 'display_currency': doc.pricelist_id.currency_id}"
										groups="account.group_show_line_subtotals_tax_included" />
								</td>
							</t>
							<t t-if="l['display_type'] == 'line_section'">
								<td colspan="99">
									<span> <t t-esc="l['line_name']" /></span>
								</td>
								<t t-set="current_section" t-value="l" />
								<t t-set="current_subtotal" t-value="0" />
							</t>
							<t t-if="l['display_type'] == 'line_note'">
								<td colspan="99">
									<span> <t t-esc="l['line_name']" /></span>
								</td>
							</t>
						</tr>
						<t
							t-if="current_section and (l_last or order_lines[l_index+1]['display_type'] == 'line_section')">
							<tr class="is-subtotal text-right">
								<td colspan="99">
									<strong class="mr16">Subtotal</strong>
									<span t-esc="current_subtotal"
										t-options='{"widget": "monetary", "display_currency": doc.pricelist_id.currency_id}' />
								</td>
							</tr>
						</t>
					</t>
				</tbody>
			</table>
		</xpath>
	</template>
</odoo>
