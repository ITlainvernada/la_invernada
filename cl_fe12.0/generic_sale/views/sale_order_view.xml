<?xml version="1.0" encoding="UTF-8"?>
<odoo>
	<record id="sale_order_search_view" model="ir.ui.view">
		<field name="name">sale.order.search</field>
		<field name="model">sale.order</field>
		<field name="inherit_id" ref="sale.view_sales_order_filter" />
		<field name="arch" type="xml">
			<xpath expr="//field[@name='user_id']" position="after">
				<field name="date_order" widget="date" />
			</xpath>
			<xpath expr="//filter[@name='customer']" position="after">
				<filter name="group_by_state" string="Estado" context="{'group_by': 'state'}" />
			</xpath>
		</field>
	</record>

	<record id="sale_order_form_view" model="ir.ui.view">
		<field name="name">sale.order.form</field>
		<field name="model">sale.order</field>
		<field name="inherit_id" ref="sale.view_order_form" />
		<field name="arch" type="xml">
			<xpath expr="//button[@name='action_quotation_send'][@states='draft']"
				position="attributes">
				<attribute name="groups">sales_team.group_sale_salesman</attribute>
			</xpath>
			<xpath expr="//button[@name='action_quotation_send'][@states='sent,sale']"
				position="attributes">
				<attribute name="groups">sales_team.group_sale_salesman</attribute>
			</xpath>
			<xpath expr="//button[@name='action_confirm'][last()]"
				position="attributes">
				<attribute name="groups">sales_team.group_sale_salesman</attribute>
			</xpath>
			<xpath expr="//button[@id='action_confirm']" position="attributes">
				<attribute name="groups">sales_team.group_sale_salesman</attribute>
			</xpath>
			<xpath expr="//button[@name='action_cancel']" position="attributes">
				<attribute name="confirm">Está seguro de cancelar éste registro?. Esta operación no se puede deshacer</attribute>
				<attribute name="groups">sales_team.group_sale_salesman</attribute>
			</xpath>
			<xpath expr="//button[@name='action_draft']" position="attributes">
				<attribute name="groups">sales_team.group_sale_salesman</attribute>
			</xpath>
			<xpath expr="//button[@name='action_done']" position="attributes">
				<attribute name="groups">sales_team.group_sale_salesman</attribute>
			</xpath>
			<field name="partner_id" position="attributes">
				<attribute name="options">{'always_reload': True,'no_quick_create':True}</attribute>
			</field>
			<field name="partner_invoice_id" position="attributes">
				<attribute name="options">{'no_quick_create': True}</attribute>
			</field>
			<field name="partner_shipping_id" position="attributes">
				<attribute name="options">{'no_quick_create': True}</attribute>
			</field>
			<xpath expr="//field[@name='client_order_ref']" position="attributes">
				<attribute name="attrs">{'readonly': ['|', ('state','=', 'cancel'), ('invoice_count','!=',0),('state','in',('sale', 'done', 'cancel'))]}</attribute>
			</xpath>
			<xpath expr="//field[@name='partner_shipping_id']" position="after">
				<xpath expr="//field[@name='client_order_ref']" position="move" />
			</xpath>
			<xpath expr="//field[@name='validity_date']" position="before">
				<xpath expr="//field[@name='date_order']" position="move" />
			</xpath>
			<field name="payment_term_id" position="attributes">
				<attribute name="attrs">{'readonly': ['|', ('state','=', 'cancel'), ('invoice_count','!=',0),('state','in',('sale', 'done', 'cancel'))]}</attribute>
			</field>
			<field name="pricelist_id" position="attributes">
				<attribute name="options">{'no_quick_create': True}</attribute>
				<attribute name="attrs">{'readonly': ['|', ('state','=', 'cancel'), ('invoice_count','!=',0),('state','in',('sale', 'done', 'cancel'))]}</attribute>
			</field>
			<field name="user_id" position="attributes">
				<attribute name="options">{'no_create': True}</attribute>
				<attribute name="attrs">{'readonly': ['|', ('state','=', 'cancel'), ('invoice_count','!=',0),('state','in',('sale', 'done', 'cancel'))]}</attribute>
			</field>
			<field name="team_id" position="attributes">
				<attribute name="attrs">{'readonly': ['|', ('state','=', 'cancel'), ('invoice_count','!=',0),('state','in',('sale', 'done', 'cancel'))]}</attribute>
			</field>
			<field name="origin" position="attributes">
				<attribute name="attrs">{'readonly': ['|', ('state','=', 'cancel'), ('invoice_count','!=',0),('state','in',('sale', 'done', 'cancel'))]}</attribute>
			</field>
			<field name="fiscal_position_id" position="attributes">
				<attribute name="attrs">{'readonly': ['|', ('state','=', 'cancel'), ('invoice_count','!=',0),('state','in',('sale', 'done', 'cancel'))]}</attribute>
			</field>
			<field name="analytic_account_id" position="attributes">
				<attribute name="options">{'no_create': True}</attribute>
				<attribute name="attrs">{'readonly': ['|', ('state','=', 'cancel'), ('invoice_count','!=',0),('state','in',('sale', 'done', 'cancel'))]}</attribute>
			</field>
			<xpath expr="//group[@name='technical']" position="attributes">
				<attribute name="groups">sales_team.group_sale_salesman</attribute>
			</xpath>
			<xpath expr="//group[@name='technical']//field[@name='origin']"
				position="attributes">
				<attribute name="groups">sales_team.group_sale_salesman</attribute>
			</xpath>
			<xpath expr="//field[@name='order_line']/tree//field[@name='product_id']"
				position="attributes">
				<attribute name="options">{'no_quick_create': True}</attribute>
			</xpath>
			<xpath expr="//field[@name='order_line']/tree//field[@name='product_uom']"
				position="attributes">
				<attribute name="options">{'no_create': True}</attribute>
			</xpath>
			<xpath expr="//field[@name='order_line']/tree//field[@name='discount']"
				position="attributes">
				<attribute name="attrs">{'readonly': [('discount_value', '&gt;', 0)]}</attribute>
				<attribute name="force_save">1</attribute>
			</xpath>
			<xpath expr="//field[@name='order_line']/tree//field[@name='discount']"
				position="after">
				<field name="discount_value" 
					force_save="1" attrs="{'readonly': [('discount', '&gt;', 0)]}"
					groups="generic_sale.group_sale_discount_value" />
			</xpath>
			<xpath
				expr="//field[@name='order_line']/tree//field[@name='analytic_tag_ids']"
				position="attributes">
				<attribute name="options">{'no_create': True}</attribute>
			</xpath>
			<xpath expr="//field[@name='order_line']/tree//field[@name='tax_id']"
				position="attributes">
				<attribute name="options">{'no_create': True}</attribute>
			</xpath>
			<xpath expr="//field[@name='order_line']/form//field[@name='product_id']"
				position="attributes">
				<attribute name="options">{'no_quick_create': True}</attribute>
			</xpath>
			<xpath expr="//field[@name='order_line']/form//field[@name='product_uom']"
				position="attributes">
				<attribute name="options">{'no_create': True}</attribute>
			</xpath>
			<xpath expr="//field[@name='order_line']/form//field[@name='discount']"
				position="attributes">
				<attribute name="attrs">{'readonly': [('discount_value', '&gt;', 0)]}</attribute>
				<attribute name="force_save">1</attribute>
			</xpath>
			<xpath expr="//field[@name='order_line']/form//div[@name='discount']"
				position="after">
				<field name="discount_value" 
					force_save="1" attrs="{'readonly': [('discount', '&gt;', 0)]}"
					groups="generic_sale.group_sale_discount_value" />
			</xpath>
			<xpath
				expr="//field[@name='order_line']/form//field[@name='analytic_tag_ids']"
				position="attributes">
				<attribute name="options">{'no_create': True}</attribute>
			</xpath>
			<xpath expr="//field[@name='order_line']/form//field[@name='tax_id']"
				position="attributes">
				<attribute name="options">{'no_create': True}</attribute>
			</xpath>
			<xpath expr="//field[@name='order_line']/.." position="after">
				<page string="Impuestos" name="tax_ids">
					<field name="tax_ids" force_save="1">
						<tree>
							<field name="tax_id" />
							<field name="base" />
							<field name="amount" />
						</tree>
					</field>
				</page>
			</xpath>
		</field>
	</record>

	<!-- filtros favoritos en Pedido de venta -->
	<record id="filter_isale_partner" model="ir.filters">
		<field name="name">Por Cliente</field>
		<field name="model_id">sale.order</field>
		<field name="user_id" eval="False" />
		<field name="context">{'group_by': ['partner_id']}</field>
	</record>

	<record id="filter_isale_month" model="ir.filters">
		<field name="name">Ventas Mensuales</field>
		<field name="model_id">sale.order</field>
		<field name="user_id" eval="False" />
		<field name="context">{'group_by': ['date_order:month']}</field>
	</record>
	
	<!-- reemplazar accion de cotizaciones para no mostrar los pedidos confirmados 
		y activar filtro de mes actual por defecto en presupuestos y pedidos de venta-->
	<record id="sale.action_quotations_with_onboarding" model="ir.actions.act_window">
		<field name="domain">[('state', 'in', ('draft', 'sent', 'cancel'))]</field>
		<field name="context">{'search_default_my_quotation': 1, 'search_default_filter_order_date': 1}</field>
	</record>
	
	<record id="sale.action_orders" model="ir.actions.act_window">
		<field name="context">{'search_default_order_date': 1}</field>
	</record>
</odoo>